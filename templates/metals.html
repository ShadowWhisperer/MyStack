{% extends "base.html" %}

{% block title %}Metals{% endblock %}

{% block content %}
<style>
    /* Tighter row height for Metals */
    #metalsTable tbody tr {
        height: 34px;
    }
    #metalsTable tbody td {
        padding: 3px 10px;
        font-size: 13px;
    }
    #metalsTable .image-col img {
        max-height: 28px;
    }
    /* Smaller camera icon */
    #metalsTable .camera-icon {
        font-size: 14px;
        padding: 3px;
    }
</style>
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-card">
            <div class="stat-label">Cost Basis</div>
            <div class="stat-value">${{ stats.cost_basis|trim_zeros }}</div>
        </div>
        <div class="stat-card">
            <div class="stat-label">Current Value</div>
            <div class="stat-value">${{ stats.current_value|trim_zeros }}</div>
        </div>
        <div class="stat-card {% if stats.gain_loss >= 0 %}positive{% else %}negative{% endif %}">
            <div class="stat-label">Gain/Loss</div>
            <div class="stat-value">${{ stats.gain_loss|trim_zeros }}</div>
        </div>
        <div class="stat-card {% if stats.gain_loss_percent >= 0 %}positive{% else %}negative{% endif %}">
            <div class="stat-label">Gain/Loss %</div>
            <div class="stat-value">{{ stats.gain_loss_percent|format_percent }}%</div>
        </div>
    </div>
    
    <!-- Action Bar -->
    <div class="action-bar">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="Search..." class="search-input">
        </div>
        <div class="action-buttons">
            <button id="addNewBtn" class="btn-icon btn-add" title="Add New Entry" style="display: none;">
                <span class="icon">+</span>
            </button>
            <button id="editModeBtn" class="btn-icon" title="Toggle Edit Mode">
                <span class="icon" id="editIcon">‚úèÔ∏è</span>
            </button>
        </div>
    </div>
    
    <!-- Data Grid -->
    <div class="data-grid-container">
        <table class="data-grid" id="metalsTable">
            <thead>
                <tr>
                    <th class="image-col">Image</th>
                    <th data-sort="metal">Metal</th>
                    <th data-sort="form">Form</th>
                    <th data-sort="count">Quantity</th>
                    <th data-sort="weight_oz">Weight (oz)</th>
                    <th data-sort="purity">Purity</th>
                    <th data-sort="year">Year</th>
                    <th data-sort="total_cost">Total Cost</th>
                    <th data-sort="current_value">Current Value</th>
                    <th data-sort="gain_loss">Gain/Loss</th>
                    <th data-sort="brand">Brand</th>
                    <th data-sort="notes">Notes</th>
                    <th class="actions-col" style="display: none;">Actions</th>
                </tr>
            </thead>
            <tbody id="metalsTableBody">
                {% for metal in metals %}
                <tr data-id="{{ metal.id }}" class="data-row">
                    <td class="image-cell">
                        {% if metal.image_filename %}
                        <div class="image-icon-wrapper">
                            <a href="{{ url_for('static', filename='images/' + metal.image_filename) }}" target="_blank" class="image-icon-link">
                                <span class="camera-icon" data-row-id="{{ metal.id }}">üì∑</span>
                            </a>
                            <input type="file" class="image-upload-input" data-row-id="{{ metal.id }}" accept="image/*" style="display: none;">
                            <img src="{{ url_for('static', filename='images/' + metal.image_filename) }}" 
                                 alt="{{ metal.metal }}" 
                                 class="hover-preview">
                        </div>
                        {% else %}
                        <span class="no-image">-</span>
                        <div class="image-icon-wrapper" style="display: none;">
                            <span class="camera-icon no-image-icon add-icon" data-row-id="{{ metal.id }}">+</span>
                            <input type="file" class="image-upload-input" data-row-id="{{ metal.id }}" accept="image/*" style="display: none;">
                        </div>
                        {% endif %}
                    </td>
                    <td class="editable" data-field="metal">{{ metal.metal }}</td>
                    <td class="editable" data-field="form">{{ metal.form }}</td>
                    <td class="editable" data-field="count">{{ metal.count }}</td>
                    <td class="editable" data-field="weight_oz">{{ metal.weight_display }}</td>
                    <td class="editable" data-field="purity">{{ metal.purity }}</td>
                    <td class="editable" data-field="year">{{ metal.year or '-' }}</td>
                    <td class="editable" data-field="total_cost">{{ metal.total_cost|int if metal.total_cost == metal.total_cost|int else "%.2f"|format(metal.total_cost) }}</td>
                    <td class="editable" data-field="current_value">{{ metal.current_value|int if metal.current_value == metal.current_value|int else "%.2f"|format(metal.current_value) }}</td>
                    <td class="{% if metal.gain_loss >= 0 %}gain-positive{% else %}gain-negative{% endif %}">
                        ${{ "%.2f"|format(metal.gain_loss) }}
                    </td>
                    <td class="editable" data-field="brand">{{ metal.brand or '-' }}</td>
                    <td class="editable" data-field="notes">{{ metal.notes or '-' }}</td>
                    <td class="actions-cell">
                        <button class="btn-delete" onclick="deleteRow({{ metal.id }})">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if not metals %}
        <div class="empty-state">
            <p>No metals added yet. Click the "pencil" to add one.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add New Modal -->
<div id="addNewModal" class="modal">
    <div class="modal-content">
        <div class="modal-body">
            <form id="addNewForm">
                <div class="form-row single-row">
                    <div class="form-group">
                        <div class="file-upload-wrapper">
                            <button type="button" class="btn-upload-image" onclick="document.getElementById('newImage').click()">Upload Image</button>
                            <span id="fileNameDisplay" class="file-name-display">No file chosen</span>
                            <input type="file" id="newImage" name="image" accept="image/*" style="display: none;" onchange="updateFileName(this)">
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newMetal">Metal</label>
                        <div class="checkbox-group inline">
                            <label class="checkbox-label">
                                <input type="radio" name="metal" value="Silver" required checked>
                                <span>Silver</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="metal" value="Gold" required>
                                <span>Gold</span>
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="newForm">Form</label>
                        <div class="checkbox-group inline">
                            <label class="checkbox-label">
                                <input type="radio" name="form" value="Coin" required>
                                <span>Coin</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="form" value="Bar" required>
                                <span>Bar</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="form" value="Round" required>
                                <span>Round</span>
                            </label>
                            <label class="checkbox-label">
                                <input type="radio" name="form" value="Other" required>
                                <span>Other</span>
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newCount">Quantity</label>
                        <input type="number" id="newCount" name="count" required value="1" min="1">
                    </div>
                    <div class="form-group">
                        <label for="newWeight">Weight (oz)</label>
                        <input type="text" id="newWeight" name="weight_oz" required placeholder="1, 0.5, 1/200">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newPurity">Purity</label>
                        <input type="text" id="newPurity" name="purity" required value=".999">
                    </div>
                    <div class="form-group">
                        <label for="newTotalCost">Total Cost</label>
                        <input type="number" id="newTotalCost" name="total_cost" required step="0.01" value="0">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newYear">Year</label>
                        <input type="text" id="newYear" name="year">
                    </div>
                    <div class="form-group">
                        <label for="newBrand">Brand</label>
                        <input type="text" id="newBrand" name="brand">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group full-width">
                        <label for="newNotes">Notes</label>
                        <textarea id="newNotes" name="notes" rows="3"></textarea>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" onclick="closeAddNewModal()">Cancel</button>
            <button type="button" class="btn-save" onclick="saveNewEntry()">Add</button>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    let editMode = false;
    let modifiedRows = new Set();
    
    // Toggle Edit Mode
    document.getElementById('editModeBtn').addEventListener('click', function() {
        editMode = !editMode;
        const editIcon = document.getElementById('editIcon');
        const addNewBtn = document.getElementById('addNewBtn');
        const actionCells = document.querySelectorAll('.actions-cell');
        const actionHeader = document.querySelector('.actions-col');
        const editableCells = document.querySelectorAll('.editable');
        const cameraIcons = document.querySelectorAll('.camera-icon');
        
        if (editMode) {
            // Switch to edit mode (save icon)
            editIcon.textContent = 'üíæ';
            this.title = 'Save All Changes';
            addNewBtn.style.display = 'block';
            
            // Show action column and header
            if (actionHeader) actionHeader.style.display = 'table-cell';
            actionCells.forEach(cell => {
                cell.style.display = 'table-cell';
            });
            
            // Enable inline editing
            editableCells.forEach(cell => {
                cell.contentEditable = true;
                cell.classList.add('editing');
            });
            
            // For each image cell, show camera icon only if no image exists
            document.querySelectorAll('.image-cell').forEach(cell => {
                const hasImage = cell.querySelector('.image-icon-link'); // Has actual image
                const dash = cell.querySelector('.no-image');
                const wrapper = cell.querySelector('.image-icon-wrapper[style*="display: none"]');
                
                if (!hasImage && dash && wrapper) {
                    // No image - show camera icon, hide dash
                    dash.style.display = 'none';
                    wrapper.style.display = 'inline-block';
                }
            });
            
            // Make camera icons clickable for upload
            cameraIcons.forEach(icon => {
                icon.style.cursor = 'pointer';
                icon.addEventListener('click', handleImageUploadClick);
            });
            
        } else {
            // Save all changes and exit edit mode
            if (modifiedRows.size > 0) {
                saveAllChanges();
            }
            
            // Switch back to view mode (pencil icon)
            editIcon.textContent = '‚úèÔ∏è';
            this.title = 'Toggle Edit Mode';
            addNewBtn.style.display = 'none';
            
            // Hide action column and header
            if (actionHeader) actionHeader.style.display = 'none';
            actionCells.forEach(cell => {
                cell.style.display = 'none';
            });
            
            // Disable inline editing
            editableCells.forEach(cell => {
                cell.contentEditable = false;
                cell.classList.remove('editing');
            });
            
            // For each image cell, hide camera icon and show dash if no image
            document.querySelectorAll('.image-cell').forEach(cell => {
                const hasImage = cell.querySelector('.image-icon-link');
                const dash = cell.querySelector('.no-image');
                const wrapper = cell.querySelector('.image-icon-wrapper[style*="display: none"], .image-icon-wrapper[style*="inline-block"]');
                
                if (!hasImage && dash && wrapper) {
                    // No image - show dash, hide camera icon
                    dash.style.display = '';
                    wrapper.style.display = 'none';
                }
            });
            
            // Remove upload handlers from camera icons
            cameraIcons.forEach(icon => {
                icon.style.cursor = '';
                icon.removeEventListener('click', handleImageUploadClick);
            });
        }
        
        this.classList.toggle('active');
    });
    
    // Handle camera icon click in edit mode
    function handleImageUploadClick(e) {
        if (!editMode) return;
        e.preventDefault();
        e.stopPropagation();
        
        const rowId = this.dataset.rowId;
        const fileInput = document.querySelector(`.image-upload-input[data-row-id="${rowId}"]`);
        if (fileInput) {
            fileInput.click();
        }
    }
    
    // Handle file selection for existing rows
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('image-upload-input')) {
            const rowId = e.target.dataset.rowId;
            const file = e.target.files[0];
            
            if (file && editMode) {
                uploadImageForRow(rowId, file);
            }
        }
    });
    
    // Track cell modifications
    document.getElementById('metalsTableBody').addEventListener('input', function(e) {
        if (e.target.classList.contains('editable')) {
            const row = e.target.closest('tr');
            const rowId = row.dataset.id;
            modifiedRows.add(rowId);
            row.classList.add('modified');
            
            // Recalculate current value if metal, weight, or count changed
            const field = e.target.dataset.field;
            if (field === 'metal' || field === 'weight_oz' || field === 'count') {
                recalculateRowValue(row);
            }
        }
    });
    
    // Recalculate current value for a row
    function recalculateRowValue(row) {
        const metal = row.querySelector('[data-field="metal"]').textContent.trim();
        const weightOz = parseFloat(row.querySelector('[data-field="weight_oz"]').textContent.trim());
        const count = parseInt(row.querySelector('[data-field="count"]').textContent.trim());
        
        if (metal && weightOz && count) {
            const currentValue = calculateCurrentValue(metal, weightOz, count);
            const currentValueCell = row.querySelector('[data-field="current_value"]');
            if (currentValueCell && currentValue) {
                currentValueCell.textContent = currentValue.toFixed(2);
            }
        }
    }
    
    // Save all changes
    function saveAllChanges() {
        if (modifiedRows.size === 0) {
            return;
        }
        
        const promises = [];
        
        modifiedRows.forEach(rowId => {
            const row = document.querySelector(`tr[data-id="${rowId}"]`);
            const data = {
                metal: row.querySelector('[data-field="metal"]').textContent.trim(),
                form: row.querySelector('[data-field="form"]').textContent.trim(),
                count: parseInt(row.querySelector('[data-field="count"]').textContent.trim()),
                weight_oz: row.querySelector('[data-field="weight_oz"]').textContent.trim(),  // Send as text
                purity: row.querySelector('[data-field="purity"]').textContent.trim(),
                year: row.querySelector('[data-field="year"]').textContent.trim(),
                total_cost: parseFloat(row.querySelector('[data-field="total_cost"]').textContent.trim()),
                current_value: parseFloat(row.querySelector('[data-field="current_value"]').textContent.trim()),
                brand: row.querySelector('[data-field="brand"]').textContent.trim(),
                notes: row.querySelector('[data-field="notes"]').textContent.trim()
            };
            
            // Replace '-' with empty string
            if (data.year === '-') data.year = '';
            if (data.brand === '-') data.brand = '';
            if (data.notes === '-') data.notes = '';
            
            const promise = fetch(`/api/metals/${rowId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });
            
            promises.push(promise);
        });
        
        Promise.all(promises)
            .then(() => {
                modifiedRows.clear();
                location.reload();
            })
            .catch(error => {
                console.error('Error saving changes:', error);
                alert('Error saving changes. Please try again.');
            });
    }
    
    // Search functionality
    document.getElementById('searchInput').addEventListener('input', function(e) {
        const searchTerm = e.target.value.toLowerCase();
        const rows = document.querySelectorAll('#metalsTableBody tr');
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(searchTerm) ? '' : 'none';
        });
    });
    
    // Delete row function
    function deleteRow(id) {
        if (!confirm('Are you sure you want to delete this entry?')) {
            return;
        }
        
        fetch(`/api/metals/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error deleting entry:', error);
            alert('Error deleting entry. Please try again.');
        });
    }
    
    // Add New Modal Functions
    document.getElementById('addNewBtn').addEventListener('click', function() {
        document.getElementById('addNewModal').style.display = 'flex';
    });
    
    function updateFileName(input) {
        const display = document.getElementById('fileNameDisplay');
        if (input.files && input.files[0]) {
            display.textContent = input.files[0].name;
        } else {
            display.textContent = 'No file chosen';
        }
    }
    
    function closeAddNewModal() {
        document.getElementById('addNewModal').style.display = 'none';
        document.getElementById('addNewForm').reset();
        // Reset purity to default
        document.getElementById('newPurity').value = '.999';
        // Reset submission flag
        isSubmitting = false;
        const saveButton = document.querySelector('.btn-save');
        saveButton.textContent = 'Add';
        saveButton.disabled = false;
    }
    
    // Calculate current value based on metal type and weight
    function calculateCurrentValue(metal, weightOz, count) {
        // Get current prices from the widget
        let pricePerOz = 0;
        
        if (metal === 'Gold') {
            const goldPrice = document.getElementById('goldPrice');
            if (goldPrice) {
                pricePerOz = parseFloat(goldPrice.textContent.replace('$', ''));
            }
        } else if (metal === 'Silver') {
            const silverPrice = document.getElementById('silverPrice');
            if (silverPrice) {
                pricePerOz = parseFloat(silverPrice.textContent.replace('$', ''));
            }
        }
        
        return pricePerOz * weightOz * count;
    }
    
    let isSubmitting = false;
    
    function saveNewEntry() {
        if (isSubmitting) {
            console.log('[CLIENT] Already submitting, ignoring duplicate click');
            return; // Prevent double submission
        }
        
        console.log('[CLIENT] saveNewEntry called at', new Date().toISOString());
        
        const form = document.getElementById('addNewForm');
        
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }
        
        // Get selected radio button values
        const metalRadio = document.querySelector('input[name="metal"]:checked');
        const formRadio = document.querySelector('input[name="form"]:checked');
        
        if (!metalRadio || !formRadio) {
            alert('Please select both Metal and Form');
            return;
        }
        
        const weightValue = document.getElementById('newWeight').value;
        const count = parseInt(document.getElementById('newCount').value);
        const metal = metalRadio.value;
        
        // Parse weight for calculation (handle fractions)
        let weightOz;
        if (weightValue.includes('/')) {
            const parts = weightValue.split('/');
            weightOz = parseFloat(parts[0]) / parseFloat(parts[1]);
        } else {
            weightOz = parseFloat(weightValue);
        }
        
        // Calculate current value based on metal price and count
        const currentValue = calculateCurrentValue(metal, weightOz, count);
        
        console.log('[CLIENT] Building FormData...');
        const formBuildStart = performance.now();
        
        // Use FormData to handle file upload
        const formData = new FormData();
        formData.append('metal', metal);
        formData.append('form', formRadio.value);
        formData.append('count', count);
        formData.append('weight_oz', weightValue);  // Send original text value
        formData.append('purity', document.getElementById('newPurity').value);
        formData.append('year', document.getElementById('newYear').value);
        formData.append('total_cost', parseFloat(document.getElementById('newTotalCost').value) || 0);
        formData.append('current_value', currentValue);
        formData.append('brand', document.getElementById('newBrand').value);
        formData.append('notes', document.getElementById('newNotes').value);
        
        // Add image file if selected
        const imageFile = document.getElementById('newImage').files[0];
        if (imageFile) {
            console.log(`[CLIENT] Image file: ${imageFile.name}, size: ${(imageFile.size/1024).toFixed(1)}KB`);
            formData.append('image', imageFile);
        }
        
        console.log(`[CLIENT] FormData built in ${(performance.now() - formBuildStart).toFixed(1)}ms`);
        
        // Disable submit button and set flag
        isSubmitting = true;
        const saveButton = document.querySelector('.btn-save');
        const originalText = saveButton.textContent;
        saveButton.textContent = 'Adding...';
        saveButton.disabled = true;
        
        console.log('[CLIENT] Starting fetch...');
        const fetchStart = performance.now();
        
        fetch('/api/metals', {
            method: 'POST',
            body: formData  // Don't set Content-Type, browser will set it with boundary
        })
        .then(response => {
            console.log(`[CLIENT] Response received in ${(performance.now() - fetchStart).toFixed(1)}ms`);
            return response.json();
        })
        .then(result => {
            console.log('[CLIENT] Response parsed:', result);
            if (result.success) {
                console.log('[CLIENT] Success! Reloading in edit mode...');
                closeAddNewModal();
                // Reload but stay in edit mode
                window.location.href = window.location.pathname + '?edit=1';
            } else {
                alert('Error: ' + (result.error || 'Unknown error'));
                isSubmitting = false;
                saveButton.textContent = originalText;
                saveButton.disabled = false;
            }
        })
        .catch(error => {
            console.error('[CLIENT] Fetch error:', error);
            alert('Error adding entry. Please try again.');
            isSubmitting = false;
            saveButton.textContent = originalText;
            saveButton.disabled = false;
        });
    }
    
    // Upload image for existing row
    function uploadImageForRow(rowId, file) {
        console.log(`Uploading image for row ${rowId}`);
        
        const formData = new FormData();
        formData.append('image', file);
        
        fetch(`/api/metals/${rowId}/image`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('Image uploaded successfully');
                // Reload but stay in edit mode
                const url = new URL(window.location);
                url.searchParams.set('edit', '1');
                window.location.href = url.toString();
            } else {
                alert('Error uploading image: ' + (result.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error uploading image');
        });
    }
    
    // Hide actions column by default
    document.addEventListener('DOMContentLoaded', function() {
        const actionCells = document.querySelectorAll('.actions-cell');
        actionCells.forEach(cell => {
            cell.style.display = 'none';
        });
        
        // Check if we should auto-enter edit mode
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('edit') === '1') {
            // Trigger edit mode
            document.getElementById('editModeBtn').click();
            // Clean up URL
            window.history.replaceState({}, '', window.location.pathname);
        }
    });
</script>
{% endblock %}
